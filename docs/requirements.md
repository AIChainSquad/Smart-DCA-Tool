# 定投计算工具需求文档

## 1. 项目概述

### 1.1 目标
开发一个自动化定投计算工具，根据预设的投资配比和市场行情，自动计算每周各标的的购买金额，并提供智能加仓建议。

### 1.2 投资组合配置
- **美股部分 (60%)**：QQQ 35%, VOO 20%, GLDM 5%
- **加密货币部分 (40%)**：BTC 45%, BNB 25%, SOL 20%, ETH 10%
- **资金限制**：每周USD上限2000，TAO上限10
- **定投时间**：周二或周三

## 2. 核心功能需求

### 2.1 行情数据获取
**功能描述**：实时获取各标的价格信息
- **美股价格**：通过API获取QQQ, VOO, GLDM的实时价格
- **加密货币价格**：获取BTC, BNB, SOL, ETH的实时价格（USDT计价）
- **汇率信息**：USD/TAO汇率（TAO是特定代币，需要USD/TAO汇率）
- **数据源**：建议使用免费API如Alpha Vantage、Yahoo Finance（美股），CoinGecko（加密货币）
- **更新频率**：至少每小时更新一次

### 2.2 定投金额计算
**功能描述**：根据目标配比自动分配每周定投资金

#### 2.2.1 基础计算逻辑
```
美股总额 = min(2000 * 0.6, 1200) USD
加密货币总额 = min(10 * TAO_USD_Price * 0.4) USD

各标的分配：
- QQQ: 美股总额 * 35%
- VOO: 美股总额 * 20% 
- GLDM: 美股总额 * 5%
- BTC: 加密货币总额 * 45%
- BNB: 加密货币总额 * 25%
- SOL: 加密货币总额 * 20%
- ETH: 加密货币总额 * 10%
```

#### 2.2.2 最小购买单位处理
- **美股**：计算购买股数，向下取整，剩余资金累积到下周
- **加密货币**：支持小数位购买，精确到小数点后6位

#### 2.2.3 配比偏离调整
- 跟踪历史购买记录，计算当前实际配比
- 当某标的实际配比偏离目标±5%时，优先分配资金进行再平衡

### 2.3 大跌检测与加仓策略
**功能描述**：监控市场波动，提供智能加仓建议

#### 2.3.1 跌幅计算基准
- **美股**：以近20个交易日均价为基准
- **加密货币**：以近30天均价为基准

#### 2.3.2 加仓等级
- **一级加仓**：跌幅10-15%，定投金额×1.5
- **二级加仓**：跌幅15-25%，定投金额×2.0
- **三级加仓**：跌幅>25%，定投金额×3.0

#### 2.3.3 资金管理
- 加仓资金来源：预留资金池或临时增加投入
- 单周加仓上限：正常定投资金的3倍
- 月度加仓次数限制：最多4次

### 2.4 购买清单生成
**功能描述**：生成详细的购买操作清单

#### 2.4.1 美股清单（IBKR格式）
```
交易日期: 2024-XX-XX
QQQ: 购买 X 股，约 $XXX.XX
VOO: 购买 X 股，约 $XXX.XX  
GLDM: 购买 X 股，约 $XXX.XX
总计: $XXXX.XX
```

#### 2.4.2 加密货币清单（Binance格式）
```
交易日期: 2024-XX-XX
BTC: 购买 X.XXXXXX，约 $XXX.XX
BNB: 购买 X.XXXXXX，约 $XXX.XX
SOL: 购买 X.XXXXXX，约 $XXX.XX
ETH: 购买 X.XXXXXX，约 $XXX.XX
总计: $XXXX.XX (TAO: X.XX)
```

## 3. 数据管理需求

### 3.1 历史记录存储
**功能描述**：记录每次定投的详细信息
- **购买记录**：日期、标的、数量、单价、总价
- **市场数据**：购买时的市场价格快照
- **配比数据**：每次购买后的实际配比情况

### 3.2 数据格式
建议使用JSON或CSV格式存储，便于后续分析：
```json
{
  "purchase_date": "2024-XX-XX",
  "asset_type": "stock|crypto",
  "purchases": [
    {
      "symbol": "QQQ",
      "quantity": 5,
      "price": 350.25,
      "total": 1751.25,
      "currency": "USD"
    }
  ],
  "market_snapshot": {
    "qqq_price": 350.25,
    "btc_price": 45000,
    "usd_tao_rate": 1.0
  }
}
```

## 4. 用户界面需求

### 4.1 命令行界面
**主要功能**：
- 显示当前市场价格
- 计算本周定投金额
- 显示配比偏离情况
- 生成购买清单
- 查看历史投资统计

### 4.2 交互命令
```bash
# 查看当前行情和定投计算
python invest_tool.py calc

# 查看历史投资记录
python invest_tool.py history

# 检查大跌情况和加仓建议  
python invest_tool.py crash-check

# 生成购买清单
python invest_tool.py generate-list

# 更新市场数据
python invest_tool.py update-prices
```

## 5. 技术实现需求

### 5.1 编程语言
Python 3.8+，使用以下主要库：
- `requests`：API调用
- `pandas`：数据处理
- `json`：配置和数据存储
- `datetime`：时间处理
- `argparse`：命令行参数解析

### 5.2 配置文件
`config.json`：
```json
{
  "portfolio": {
    "stock_allocation": {
      "QQQ": 0.35,
      "VOO": 0.20, 
      "GLDM": 0.05
    },
    "crypto_allocation": {
      "BTC": 0.45,
      "BNB": 0.25,
      "SOL": 0.20,
      "ETH": 0.10
    }
  },
  "limits": {
    "weekly_usd_limit": 2000,
    "weekly_tao_limit": 10
  },
  "api_keys": {
    "alpha_vantage": "your_key",
    "coingecko": "your_key"
  }
}
```

### 5.3 API集成
- **Alpha Vantage**：美股实时价格
- **CoinGecko**：加密货币价格
- **汇率API**：USD/TAO汇率（如需要）

## 6. 扩展功能需求

### 6.1 通知功能
- 邮件提醒：每周定投时间提醒
- 大跌警报：当检测到显著下跌时发送通知

### 6.2 分析报告
- 月度投资报告：投资总额、收益率、配比分析
- 年度总结：投资表现对比基准指数

### 6.3 风险管理
- 投资上限监控：防止超出预算
- 集中度风险提醒：某标的占比过高时警告

## 7. 项目实施计划

### Phase 1：核心功能开发
1. 搭建项目框架
2. 实现价格数据获取
3. 开发定投计算逻辑
4. 建立数据存储机制

### Phase 2：智能功能
1. 大跌检测算法
2. 配比偏离调整
3. 购买清单生成

### Phase 3：用户体验优化
1. 命令行界面完善
2. 错误处理和异常情况
3. 配置文件管理

### Phase 4：扩展功能
1. 通知系统
2. 报告生成
3. 性能优化

## 8. 验收标准

- [ ] 能够准确获取所有标的的实时价格
- [ ] 定投金额计算准确，符合配比要求
- [ ] 能够检测市场大跌并给出合理加仓建议
- [ ] 生成的购买清单格式正确，便于操作
- [ ] 历史数据记录完整，支持后续分析
- [ ] 命令行操作简单直观
- [ ] 处理网络异常和数据错误的容错机制